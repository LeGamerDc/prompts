# 记忆维护工作流

## 触发时机

- 用户表示会话结束（"今天到这里"、"收工"、"结束"等）
- 用户明确要求"整理记忆"
- 完成某模块的里程碑（如从"设计中"进入"开发中"）

## 会话收尾流程

### 1. 回顾会话

扫描本次会话内容，提取：
- 新做出的技术决策（含理由和权衡）
- 发现的技术债务
- 发现的问题和风险
- 变更的文档（架构文档、代码、协议）
- 新增或变更的模块间依赖
- 模块状态变化

### 2. 更新 Memory

**项目级 `memory/project.md`：**
- 更新「模块进度」中相关模块的状态和完成度
- 添加新的「技术决策」条目
- 添加「技术债务」（如有新发现）
- 添加「待解决」问题
- 写入「回顾」摘要（一句话概括本次会话成果）

**模块级 `memory/modules/<module>.md`（涉及的模块）：**
- 更新「状态」和「完成度」
- 添加「决策历史」条目
- 更新「技术债务」
- 更新「待解决」
- 更新「依赖」关系

**同步更新：**
- `gdd-mapping.md`「状态」列（如有模块进度变化）
- `arch.md` 索引摘要（如有文档结构变化）

### 3. 清理操作

逐一检查 memory 条目，执行以下操作：

| 条目状态 | 操作 |
|----------|------|
| 决策已完整落实到文档/代码中 | **归档**：替换为简短引用（"详见 `architecture/server.md` §模块名"） |
| 已被新决策推翻 | **淘汰**：删除，在新决策中注明"替代了旧决策" |
| 多条相关但分散的记录 | **合并**：整合为一条完整记录 |
| 冗长的讨论过程记录 | **压缩**：只保留结论 + 关键理由 |
| 技术债务已解决 | **移除**：从技术债务列表删除 |
| 技术债务优先级变化 | **更新**：调整优先级标记 |

### 4. 健康检查

- `memory/project.md` 是否 < 200 行？超出则进一步压缩
- 各 `memory/modules/*.md` 是否 < 100 行？超出则进一步压缩
- 是否有孤立引用（指向不存在的文档或模块）？
- 是否有状态不一致（memory 说"已完成"但文档有 TODO）？
- `gdd-mapping.md` 是否与实际模块状态一致？
- `arch.md` 索引是否与实际文档结构一致？

### 5. 向用户汇报

输出维护摘要：

```markdown
## 记忆维护报告

### 本次更新
- 新增决策: N 条
- 新增技术债务: N 条
- 归档: N 条
- 淘汰: N 条
- 压缩: N 条

### 当前模块状态
- [模块名]: [阶段] [完成度]
- ...

### 技术债务概览
- [高优先级] N 条
- [中优先级] N 条
- [低优先级] N 条

### 建议下次工作方向
- <具体建议，基于优先级和依赖关系>
```
