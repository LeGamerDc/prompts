# 开发规划工作流

## 触发条件

设计文档（tech-stack、architecture、code-structure、protocols）基本完成，用户准备进入开发阶段，或用户明确要求进行任务拆分。

## 前置条件检查

以下文档必须已创建并有实质内容（非空模板）：

- `architecture/frontend.md` 或 `architecture/server.md`（至少一个）
- `code-structure/frontend.md` 或 `code-structure/server.md`（至少一个）
- `architecture/protocols/overview.md`（如有通信需求）

如前置条件不满足，提醒用户先完善设计文档，指出缺失的部分。

## 工作流程

### 1. 全面载入

使用 subagent 并行读取所有设计文档：

- 全部 `architecture/` 文档
- 全部 `code-structure/` 文档
- `gdd-mapping.md`
- `conventions/coding.md`
- `architecture/protocols/` 相关文件
- 全部相关 GDD 系统文档

### 2. 识别开发单元

从设计文档中提取所有需要实现的功能单元。按以下维度梳理：

**自底向上识别：**
1. 基础设施 — 日志、配置加载、错误处理等通用能力
2. 协议与数据 — protobuf 定义、数据模型实现、配置 schema
3. 公共工具 — 共享算法、工具函数、类型定义
4. 核心系统 — GDD 核心循环对应的前后端实现
5. 周边系统 — GDD 其他系统的前后端实现
6. 开发工具 — 配置验证、测试工具、调试辅助

### 3. 分析依赖关系

对每个任务明确：

- **输入依赖**：需要哪些任务先完成（接口、数据结构、工具）
- **输出被依赖**：哪些后续任务需要它的产出
- **接口约定**：与上下游任务之间的接口是什么（函数签名、消息格式、文件路径）

常见依赖模式：
```
协议定义 → 前后端通信实现
基础设施/工具库 → 所有业务功能
数据模型实现 → 需要持久化的功能
配置系统 → 需要配置数据的功能
服务端核心逻辑 → 服务端周边功能
前端基础框架 → 前端具体页面/组件
```

### 4. 划分开发阶段

将任务按依赖关系分层：

- **P1 基础层**：无依赖或仅依赖设计文档的任务（协议定义、基础工具、项目脚手架）
- **P2 核心层**：依赖 P1 产出的核心业务功能
- **P3 扩展层**：依赖 P1+P2 的周边功能
- **P4+ 更多层**：按需继续

原则：
- 同一阶段内的任务尽量无相互依赖，可并行/独立开发
- 每个阶段完成后，用户可以验收再推进下一阶段
- 阶段之间的接口必须在设计文档中明确定义

### 5. 编写任务详情

每个任务必须是**自包含**的——执行该任务的 agent 只需读取任务中列出的文档就能开始工作，不需要额外探索或询问上下文。

**任务详情要求：**

1. **范围明确**：清楚说明做什么和不做什么，避免范围蔓延
2. **文档清单完整**：列出所有需要读取的文件路径和读取目的
3. **产出可预期**：指明会创建或修改哪些文件
4. **依赖显式化**：标明依赖的任务及具体需要什么（不是泛泛的"依赖 T01"）
5. **验收可检查**：标准应该是 agent 或用户能明确判断 yes/no 的

### 6. 任务粒度检查

验证每个任务的合理性：

- [ ] 任务是否可在一个 agent 会话中完成？（约 3-5 个文件的创建或修改）
- [ ] 任务描述是否自包含？（agent 不需要额外探索就能理解全部上下文）
- [ ] 依赖关系是否完整？（没有遗漏的隐式依赖）
- [ ] 验收标准是否可检查？（agent 或用户能明确判断是否完成）
- [ ] 产出是否与 `code-structure/` 中定义的目录结构一致？

如果任务过大（>5 个文件修改），继续拆分；如果过小（1 个简单文件），考虑合并。

### 7. 与用户确认

向用户展示开发计划，重点讨论：

- 阶段划分是否合理
- 任务优先级是否正确
- 是否有遗漏的功能
- 任务粒度是否合适
- 开发顺序是否符合用户预期

### 8. 写入 dev-plan.md

确认后创建 `project/dev-plan.md`，按 SKILL.md 中的格式规范填充。

同时更新：
- `memory/project.md` — 记录"完成开发规划"决策，更新阶段为"开发"
- `arch.md` — 在索引中添加 `dev-plan.md` 链接

## 迭代更新

开发过程中发现需要调整计划时：
- 新增任务 → 分配 ID，插入合适阶段，更新依赖关系
- 拆分任务 → 原任务标记为"已拆分"，创建子任务
- 合并任务 → 保留一个 ID，标注合并来源
- 取消任务 → 标记为"已取消"并注明原因，不删除（保留历史）
