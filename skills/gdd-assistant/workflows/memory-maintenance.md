# 记忆维护工作流

## 触发时机

- 用户表示会话结束（"今天到这里"、"收工"、"结束"等）
- 用户明确要求"整理记忆"
- 完成某系统设计里程碑（如从"概念"进入"设计中"）

## 会话收尾流程

### 1. 回顾会话

扫描本次会话内容，提取：
- 新做出的决策（含理由）
- 产生的创意（标记分析状态）
- 发现的问题
- 变更的文档
- 新增或变更的系统间接口
- 用户表达的偏好

### 2. 更新 Memory

**项目级 `memory/project.md`：**
- 更新「进度概览」中相关系统的状态
- 添加新的「关键决策」条目
- 更新「跨系统约定」（如有新增）
- 添加「待解决」问题
- 记录「用户偏好」（如有新发现）
- 写入「回顾」摘要（一句话概括本次会话成果）

**系统级 `memory/systems/<system>.md`（涉及的系统）：**
- 更新「状态」和「完成度」
- 添加「决策历史」条目
- 更新「创意池」
- 更新「待解决」
- 更新「系统接口」

### 3. 清理操作

逐一检查 memory 条目，执行以下操作：

| 条目状态 | 操作 |
|----------|------|
| 决策已完整落实到文档中 | **归档**：替换为简短引用（"详见 `systems/X/main.md` §Y"） |
| 已被新决策推翻 | **淘汰**：删除，在新决策条目中注明"替代了旧决策" |
| 多条相关但分散的记录 | **合并**：整合为一条完整记录 |
| 冗长的讨论过程记录 | **压缩**：只保留结论 + 关键理由 |
| 创意已采纳并写入文档 | **归档**：从创意池移除，决策历史中保留采纳记录 |
| 创意已否决 | 保留否决原因，供日后参考。若积压过多可清理最早的 |

### 4. 健康检查

- `memory/project.md` 是否 < 200 行？超出则进一步压缩
- 各 `memory/systems/*.md` 是否 < 100 行？超出则进一步压缩
- 是否有孤立引用（指向不存在的文档或系统）？
- 是否有状态不一致（memory 说"已完成"但文档有 TODO）？

### 5. 向用户汇报

输出维护摘要：

```markdown
## 记忆维护报告

### 本次更新
- 新增决策: N 条
- 新增创意: N 条
- 归档: N 条
- 淘汰: N 条
- 压缩: N 条

### 当前状态
- [系统名]: [阶段] [完成度]
- ...

### 建议下次工作方向
- <具体建议>
```
